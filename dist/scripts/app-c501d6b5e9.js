!function(){"use strict";angular.module("fsm",[]),angular.module("troutSpotr",["ngAnimate","ngCookies","ngAria","ui.router","fsm","infinite-scroll"])}(),angular.module("troutSpotr").directive("streamListItemDirective",function(){return{templateUrl:"app/ui/streamList/streamListItem/streamlistitemtemplate.html",restrict:"A",link:function(t,e,n){t.isSmall=!0,t.isAlertSymbolDisplayed=function(){if(t.isSmall===!1)return!1;var e=t.stream.Restrictions.length>0,n=null!=t.stream.AlertMessage&&t.stream.AlertMessage.length>0;return e&&n?!0:void 0},t.getAlertMessage=function(){return t.stream.AlertMessage},t.expand=function(){t.isSmall=!t.isSmall,console.log(t.stream)},t.getCounties=function(){return t.stream.Counties?t.stream.Counties.map(function(t){return t.Name}).join(","):null},t.getAlternativeNames=function(){return t.stream.LocalNames?0===t.stream.LocalNames.length?"":"aka "+t.stream.LocalNames.join(","):null}}}}),angular.module("troutSpotr").directive("streamListItemHeader",function(){return{templateUrl:"app/ui/streamList/streamListItem/StreamListItemHeaderTemplate.html",restrict:"A",link:function(t,e,n){}}}),angular.module("troutSpotr").directive("regionHeader",["StreamApiService",function(t){return{templateUrl:"app/ui/streamList/region/RegionHeaderTemplate.html",restrict:"A",link:function(t,e,n){t.displayedCounties=[],t.init=function(){t.clearCounties()},t.clearCounties=function(){t.displayedCounties=[]},t.loadMoreCounties=function(e){console.log("calling loadMoreStreams");var n=t.displayedCounties.length,r=t.region.children.length;e=null==e?1:e;var i=r-n;e=Math.min(i,e);var a=n+e;console.log("Total counties: ",r),console.log("starting to add things from ",n," to ",a);for(var o=n;a>o;o++){var s=t.region.children[o];t.displayedCounties.push(s),console.log("added county named ",s)}},t.getScrollContainer=function(){return"#js-list-container"},t.getRegionScrollBodyId=function(e){var n="#"+t.getRegionId(e);return n},t.getRegionId=function(t){var e="hdr-region_"+t.id;return e},t.init()}}}]),angular.module("troutSpotr").directive("countyHeader",["StreamApiService",function(t){return{templateUrl:"app/ui/streamList/county/CountyHeaderTemplate.html",restrict:"A",link:function(t,e,n){t.displayedStreams=[],t.init=function(){t.clearStreams()},t.clearStreams=function(){t.displayedStreams=[]},t.loadMoreStreams=function(e){console.log("calling loadMoreStreams");var n=t.displayedStreams.length,r=t.county.children.length;e=null==e?15:e;var i=r-n;e=Math.min(i,e);var a=n+e;console.log("Total streams: ",r),console.log("starting to add things from ",n," to ",a);for(var o=n;a>o;o++){var s=t.county.children[o];t.displayedStreams.push(s),console.log("added stream named ",s)}},t.getCountyScrollBodyId=function(e){var n="#"+t.getCountyId(e);return console.log(n),n},t.getScrollContainer=function(){return"#js-list-container"},t.getCountyId=function(t){return"hdr-county_"+t.id},t.init()}}}]),angular.module("troutSpotr").directive("streamRatio",["StreamRatioViewModel",function(t){return{templateUrl:"app/ui/streamRatio/streamratiotemplate.html",restrict:"A",link:function(e,n,r){var i=new t(e.stream.TroutStreamsLength,e.stream.PalsLength);e.streamRatio=i}}}]),angular.module("troutSpotr").directive("streamList",["StreamApiService",function(t){return{templateUrl:"app/ui/streamList/streamlisttemplate.html",restrict:"A",link:function(t,e,n){t.stage={isLoaded:!1,streams:null,selectedStream:null},t.getScrollContainer=function(){return"#js-list-container"},t.$watch("stage.selectedStream",function(t,e){})}}}]),angular.module("troutSpotr").controller("StreamlistcontrollerCtrl",["$scope","StreamApiService","TableOfContentsRepository","RegionGeometryService","$anchorScroll",function(t,e,n,r,i){t.isSmallView=!1;var a=function(){var t={isExpanded:!1,isLoading:!1,selectedRegionGeometry:null,selectedRegion:null,selectedCounty:null,highlightedStream:null,currentClientCoordinates:[NaN,NaN]};return t};t.mapState=a(),t.selectCounty=function(t){console.log(t)},t.selectRegion=function(e){if(null==e)throw new Error("regionModel cannot be null");var n=!1;if(n)return t.mapState.selectedRegionGeometry=null,void(t.mapState.selectedRegion=[e]);var a=e.parent;return r.getRegion(a,e).then(function(n){return t.mapState.selectedRegionGeometry=[n],t.mapState.selectedRegion=[e],i("region-hdr_"+e.id),n})},t.getTableOfContents=function(){return n.getTableOfContents().then(function(t){return t})},t.bustCache=function(){console.log("busting cache..."),n.bustTableOfContentsCache()},t.toggleMinimap=function(){null!=t.mapState&&(t.mapState.isExpanded=!t.mapState.isExpanded)}}]),angular.module("troutSpotr").directive("streamLine",["LinearReferenceViewModel",function(t){return{templateUrl:"app/ui/streamLine/streamlinetemplate.html",restrict:"A",link:function(e,n,r){var i=parseFloat(e.stream.LengthMiles);if(!(0>=i)){e.stage={width:n.width()};var a=function(t){var n=Math.floor(i),r=[];if(1>n)return r.push({xOffset:0,width:1,height:3,yOffset:7}),r;for(var a=e.stage.width/t,o=0;n>=o;o++)r.push({xOffset:o*a,width:1.5,height:4,yOffset:8});return r};e.drawLines=function(){var r=parseFloat(e.stream.LengthMiles),i=1/r;e.streamLine=d3.select(n[0]).append("svg").attr("class","stream-line").attr("width",e.stage.width).attr("height",16).attr("xmlns","http://www.w3.org/2000/svg"),e.publicSegments=e.stream.Pal.Sections.map(function(e){return new t(e,i)}),e.streamLine.publicLand=e.streamLine.append("g").attr("class","stream-line_public-land"),e.streamLine.publicLand.selectAll("rect").data(e.publicSegments).enter().append("rect").attr("x",function(t){return t.xOffset*e.stage.width}).attr("y",0).attr("width",function(t){return t.width*e.stage.width}).attr("height",11).attr("rx",4).attr("ry",4).attr("class","public-land"),e.streamLine.stream=e.streamLine.append("g").attr("class","stream-line_stream").append("rect").attr("x",0).attr("y",3).attr("height",5).attr("width",e.stage.width),e.lakes=e.stream.Lakes.Sections.map(function(e){return new t(e,i)}),e.accessPoints=e.stream.AccessPoints,e.streamLine.lakes=e.streamLine.append("g").attr("class","stream-line_stream"),e.streamLine.lakes.selectAll("rect").data(e.lakes).enter().append("rect").attr("x",function(t){return t.xOffset*e.stage.width}).attr("y",1).attr("width",function(t){return t.width*e.stage.width}).attr("height",9).attr("rx",4).attr("ry",4).attr("class","stream-line_stream"),e.publicSegments=e.stream.TroutStreams.Sections.map(function(e){return new t(e,i)}),e.streamLine.troutStreamSections=e.streamLine.append("g").attr("class","stream-line_route"),e.streamLine.append("g").attr("class","stream-line_route").selectAll("g").data(e.publicSegments).enter().append("g").append("rect").attr("x",function(t){return t.xOffset*e.stage.width}).attr("y",3).attr("width",function(t){return t.width*e.stage.width}).attr("height",5).attr("class","stream-line_route"),e.stream.Restrictions.forEach(function(n,r){var a=n.Sections.map(function(e){var n=new t(e,i);return e.segment=n,e});e.streamLine.append("g").attr("class",0===r?"stream-line_restriction":"stream-line_restriction_secondary").selectAll("g").data(a).enter().append("g").append("rect").attr("x",function(t){return t.segment.xOffset*e.stage.width}).attr("y",3).attr("width",function(t){return t.segment.width*e.stage.width}).attr("height",5).attr("class","restriction")}),e.streamLine.roadIntersections=e.streamLine.append("g").attr("class","stream-line_roadIntersections"),e.streamLine.roadIntersections.selectAll("circle").data(e.accessPoints).enter().append("circle").attr("cy",5).attr("r",2).attr("cx",function(t){return(1-t.LinearOffset/r)*e.stage.width}).attr("class",function(t){return t.IsOverOrNearPublicLand?"roadIntersetion_public":"roadIntersetion_private"});var o=a(r),s=o[0];s.width=1,s.height=3,e.streamLine.tickMarks=e.streamLine.append("g").attr("class","stream-line_grid-lines").selectAll("rect").data(o).enter().append("rect").attr("x",function(t){return e.stage.width-t.xOffset-t.width}).attr("y",function(t){return t.yOffset}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height}).attr("class","tick")},e.drawLines()}}}}]),function(t){var e=t.module("fsm");e.directive("fsmStickyHeader",["$rootScope",function(t){return{restrict:"EA",replace:!1,scope:{scrollBody:"=",scrollStop:"=",scrollableContainer:"=",contentOffset:"=",scrollObject:"=",zIndexOverride:"="},link:function(e,n,r,i){function a(){if(m.is("tr")||m.is("thead")){var t=m.find("th");l.find("th").each(function(e,n){var r=$(t[e]);r.css("width",n.offsetWidth+"px")})}}function o(){var t=p.scrollTop()+e.scrollStop,n=u();if(1===n.length){var r=n.offset().top,i=r+n.outerHeight(!1);if(t>r&&i>t)if(m||(c(),m.css({visibility:"visible"})),i>t&&t>i-m.outerHeight(!1)){var a=i-t+e.scrollStop-m.outerHeight(!1);m.css("top",a+"px")}else s();else m&&(l.remove(),l=m,m=null,l.removeClass("fsm-sticky-header"),l.css({position:"relative",left:0,top:0,width:"auto","z-index":0,visibility:"visible"}))}}function s(){m.css({top:e.scrollStop,width:l.outerWidth(),left:l.offset().left}),a()}function c(){t.$broadcast("header-clone",e.scrollObject),m=l,l=m.clone(),m.after(l),m.addClass("fsm-sticky-header"),m.css({position:"fixed","z-index":e.zIndexOverride,visibility:"hidden"}),s()}var l=$(n,this),u=function(){return(null==d||1!==d.length)&&(d=$(e.scrollBody)),d};e.zIndexOverride=null!=e.zIndexOverride?e.zIndexOverride:1e4;var d=u(),m=null,d=$(e.scrollBody),p=$(e.scrollableContainer);e.contentOffset||0;0===p.length&&(p=$(window)),p.on("scroll.fsmStickyHeader",o).trigger("scroll"),p.on("resize.fsmStickyHeader",o),e.$on("$destroy",function(){p.off(".fsmStickyHeader")})}}}]),e.directive("fsmMenu",["$location",function(e){return{restrict:"A",scope:{},link:function(n,r,i){function a(e){var n=t.element(e.currentTarget),r=n.next(".fsm-sub-menu");r.slideToggle("fast",function(){var t=n.children("[class*='fa-chevron']");t.toggleClass("fa-chevron-down fa-chevron-up"),f=m.find("[tc-menu-item]:visible")})}function o(t){g=u(),9===t.keyCode?s(t):13===t.keyCode||37===t.keyCode||39===t.keyCode?c(t):(38===t.keyCode||40===t.keyCode)&&l(t)}function s(t){if(t.shiftKey)$("[fsm-menu-button]").focus();else{var e=$("[tabindex=1]");if(0==e.length)return;e.focus()}t.preventDefault(),t.stopPropagation()}function c(t){t.currentTarget=$(f[g]).children("a").first(),a(t)}function l(t){t.preventDefault(),t.stopPropagation(),38===t.keyCode?g>0?$(f[g-1]).children("a").first().focus():$(f[f.length-1]).children("a").first().focus():40===t.keyCode&&(g<f.length-1?$(f[g+1]).children("a").first().focus():$(f[0]).children("a").first().focus())}function u(){var t=m.find(":focus");return 1===t.length?f.index(t.parent("[tc-menu-item]").first()):f.index(m.find("[tc-menu-item].active").first())}function d(t){t.preventDefault(),t.stopPropagation(),g=u(),$(f[g]).children("a").first().focus()}var m=t.element(r),p=m.find(".fsm-menu-title"),f=m.find("[tc-menu-item]:visible"),g=0;p.click(a),m.keydown(o),m.focus(d),n.$watch(function(){return e.path()},function(e){var n=r.find("a[href^='#']");t.forEach(n,function(n){var r=t.element(n),i=r.attr("href").split("#")[1];if(0==e.indexOf(i)){t.element(n.parentElement).addClass("active");var a=r.parents(".fsm-sub-menu");a.show();var o=a.prev().children("[class*='fa-chevron']");o.removeClass("fa-chevron-down"),o.addClass("fa-chevron-up")}else t.element(n.parentElement).removeClass("active")}),f=m.find("[tc-menu-item]:visible")})}}}]),e.directive("fsmMenuButton",function(){return{restrict:"EA",replace:!1,scope:{},link:function(t,e,n,r){function i(t){77===t.keyCode&&t.ctrlKey&&t.altKey?(a()&&o(),$("[fsm-menu]").focus()):77===t.keyCode&&t.ctrlKey&&(l.focus(),o())}function a(){return $("body").hasClass("fsm-menu-toggle")}function o(){$("body").toggleClass("fsm-menu-toggle"),c(),setTimeout(c,50)}function s(t){(32===t.keyCode||13===t.keyCode)&&(t.preventDefault(),t.stopPropagation(),o())}function c(){l.find(".fsm-menu-button-open").toggleClass("fsm-spin-forward"),l.find(".fsm-menu-button-close").toggleClass("fsm-spin-backward")}var l=$(e,this);l.addClass("fsm-menu-button"),l.keydown(s),$("body").keydown(i),l.on("click.fsmMenuButton",o),t.$on("$destroy",function(){l.off(".fsmMenuButton")})}}}),e.directive("fsmBigData",["$filter",function(t){return{restrict:"AE",scope:{},replace:!1,transclude:!0,link:function(e,n,r,i,a){var o=t("orderBy"),s=0,c=r.fsmBigData.split(" of ")[0],l=r.fsmBigData.split(" of ")[1],u=parseInt(l.split(" take ")[1],10),d=l.split(" take ")[0],m=[],p=[],f=[],g=$(window),h=["None","Ascending","Descending"],v=[];a(function(t,e){function r(){var t=p.slice(u*s,u*(s+1));t.length>0&&(f.push.apply(f,t),s++)}function i(){p=v.length?o(m,v):m,f.length=0,s=0,r()}function a(t,e){for(var n=0;n<v.length;n++)v[n].indexOf(t)>-1&&v.splice(n,1);if(e>0){var r="";"Descending"===h[e]&&(r="-"),v.unshift(r+t)}i()}function l(){var t=$(window).scrollTop(),n=$(document).height(),i=$(window).height(),a=t/(n-i);a>.98&&e.$apply(r)}e.sortTypes=h,n.append(t),e[c]=f,e.$parent.$watchCollection(d,function(t){t&&(m=t,i())}),e.addSortColumn=a,g.on("scroll.fsmBigData",l).trigger("scroll"),e.$on("$destroy",function(){g.off(".fsmBigData")})})}}}]),e.directive("fsmSort",[function(){var e='<i class="fa fa-sort"></i>';return{restrict:"AE",replace:!1,scope:{},link:function(n,r,i){function a(){l.removeClass("fa-sort-desc fa-sort-asc fa-sort");var t="fa-sort";"Ascending"===n.$parent.sortTypes[u]?t="fa-sort-asc":"Descending"===n.$parent.sortTypes[u]&&(t="fa-sort-desc"),l.addClass(t)}function o(){u++,u==n.$parent.sortTypes.length&&(u=0),n.$apply(n.$parent.addSortColumn(c,u)),a()}var s=r,c=i.fsmSort,l=t.element(e);s.append("&nbsp;"),s.append(l);var u=0;s.css({cursor:"pointer"}),s.on("click.fsmSort",o),s.on("keydown.fsmSort",function(t){13===t.keyCode&&(o(),t.preventDefault(),t.stopPropagation())}),n.$on("$destroy",function(){s.off(".fsmSort")})}}}])}(window.angular),angular.module("troutSpotr").directive("speciesSummary",function(){return{templateUrl:"app/ui/speciesSummary/speciessummarytemplate.html",restrict:"A",link:function(t,e,n){}}}),angular.module("troutSpotr").directive("restrictionLegend",function(){return{templateUrl:"app/ui/restrictions/restrictionlegendtemplate.html",restrict:"A",link:function(t,e,n){console.log("restrictionlegend directive",t.stream)}}});var MINI_MAP_CLASS=".js-mini-map";angular.module("troutSpotr").directive("miniMapDirective",["$rootScope","GeometryApiService","$q","$timeout",function(t,e,n,r){return{templateUrl:"app/ui/miniMap/minimaptemplate.html",restrict:"A",link:function(e,n,i){function a(){console.log("reset!"),e.active.classed("active",!1),e.active=d3.select(null),e.svg.transition().duration(300).call(e.zoom.translate([0,0]).scale(1).event)}function o(){e.root.style("stroke-width",1.5/d3.event.scale+"px"),e.root.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function s(t){c(),e.minimapState.loadingRegion=d3.select(this).classed("minimap-geogrpahy_region_loading",!0);var n=t.children.map(function(t){return t.children}),r=_.unique(_.flatten(n),"Id"),i=e.streams.selectAll("path.minimap-geography_stream").data(r,function(t){return t.Id});i.enter().append("path").attr("class","minimap-geography_stream").attr("data-id",function(t){return t.id}).attr("id",function(t){return"streamPoint_"+t.id}).attr("data-name",function(t){return t.name}).attr("d",function(t){return e.path(t.geometry)}).style("opacity",0).transition().delay(200).duration(750).style("opacity",1),i.exit().transition().duration(300).style("opacity",0).remove()}function c(){null!=e.minimapState.loadingRegion&&(e.minimapState.loadingRegion.classed("minimap-geogrpahy_region_loading",!1),e.minimapState.loadingRegion=d3.select(null))}function l(t){if(e.active.node()===this)return a();e.active.classed("active",!1),e.active=d3.select(this).classed("active",!0);var n=e.path.bounds(t.geometry),r=n[1][0]-n[0][0],i=n[1][1]-n[0][1],o=(n[0][0]+n[1][0])/2,s=(n[0][1]+n[1][1])/2,c=.95/Math.max(r/e.minimapState.width,i/e.minimapState.height),l=[e.minimapState.width/2-c*o,e.minimapState.height/2-c*s];e.svg.transition().delay(200).duration(750).call(e.zoom.translate(l).scale(c).event)}function u(t){if(null==t)return"";var e=t.statefp+t.countyfp;return e}function d(t){return"county_"+u(t)}function m(t){var n=d(t),r="[data-id="+n+"]",i=e.counties.select(r).node();e.selectedCounty.node()!==i&&(e.selectedCounty.classed("active",!1),e.selectedCounty=d3.select(i).classed("active",!0))}function p(){d3.event.defaultPrevented&&d3.event.stopPropagation()}e.minimapState={isLoading:!0,regionGeometries:null,selectedRegionId:null,selectedCountyId:null,width:45,height:45,isMacro:!0,loadingRegion:d3.select(null)},e.active=d3.select(null),e.selectedCounty=d3.select(null),t.$on("county-select",function(t,e){console.log(e)}),t.$on("header-clone",function(t,n){null!=n&&("region"===n.type&&r(function(){e.minimapState.selectedRegionId=n.id,e.$apply()}),"county"===n.type&&r(function(){e.minimapState.selectedCountyId=n.name,e.$apply()}))});var f=e.$watch(function(){return e.minimapState.selectedRegionId},function(t,n){if(null!=t&&t!==n){var r=e.currentRegions.filter(function(e){return e.id===t});r.length>0&&t!==n&&l(r[0])}}),g=e.$watch(function(){return e.minimapState.selectedCountyId},function(t,n){if(null!=t){var r=e.currentCounties.filter(function(e){return e.name===t});r.length>0&&t!==n&&m(r[0])}}),h=e.$watch(function(){return e.minimapState.regionGeometries},function(t,e){null!=t&&(console.log("new Geometries!",t),v(t))}),v=function(t){var e=d3.select(n[0]);console.log(e)},y=function(t){e.projection=d3.geo.albersUsa().scale(1).translate([0,0]),e.path=d3.geo.path().projection(e.projection).pointRadius(.15);var r=t.geometry,i=e.path.bounds(r),a=.95/Math.max((i[1][0]-i[0][0])/e.minimapState.width,(i[1][1]-i[0][1])/e.minimapState.height),s=[(e.minimapState.width-a*(i[1][0]+i[0][0]))/2,(e.minimapState.height-a*(i[1][1]+i[0][1]))/2];e.projection.scale(a).translate(s),e.zoom=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([1,8]).size([40,40]).on("zoom",o),e.svg=d3.select(n[0]).select(MINI_MAP_CLASS).append("svg").attr("viewBox","0 0 "+e.minimapState.width+" "+e.minimapState.height).attr("preserveAspectRatio","xMinYMin meet").attr("class","minimap-root").on("click",p,!0),e.root=e.svg.append("g").attr("class","minimap-geography"),e.root.append("rect").attr("class","minimap-geography_background").attr("width","100%").attr("height","100%").on("click",w),e.counties=e.root.append("g").attr("class","minimap-geography minimap-geogrpahy_counties"),e.states=e.root.append("g").attr("class","minimap-geography minimap-geogrpahy_states"),e.streams=e.root.append("g").attr("class","minimap-geography minimap-geogrpahy_streams"),e.regions=e.root.append("g").attr("class","minimap-geography minimap-geogrpahy_regions")},S=function(t,n){var i=e.minimapState.isMacro;i?(s.bind(this)(t),e.minimapState.selectedRegionId=t.id,e.selectRegion(t).then(function(t){r(function(){c(),r(C,500)},1e3)})):b(),r(function(){e.$apply()})},w=function(){var t=e.minimapState.isMacro;console.log(t),t?C():b(),r(function(){e.$apply()})},C=function(){e.minimapState.isMacro=!1},b=function(){e.minimapState.isMacro=!0,a()},x=function(t,n,r){e.counties.selectAll("path.minimap-geography_county").data(r,function(t){return t.id}).enter().append("path").attr("d",function(t){return e.path(t.geometry)}).attr("data-id",function(t){return d(t)}).attr("class","minimap-geography_county"),e.regions.selectAll("path.minimap-geogrpahy_region").data(n,function(t){return t.id}).enter().append("path").attr("class","minimap-geogrpahy_region").attr("data-id",function(t){return t.id}).attr("id",function(t){return"region_"+t.id}).attr("data-name",function(t){return t.shortName}).attr("d",function(t){return e.path(t.geometry)}).on("click",S)};e.getTableOfContents().then(function(t){console.log("minimap got toc");var n=_.map(t),r=_(n).pluck("children").flatten().value(),i=_(r).pluck("children").flatten().value();e.currentState=n[0],e.currentCounties=i,e.currentRegions=r;var a=0,o=e.currentCounties.map(function(t){return Math.max(0,t.stream_count)}),s=d3.max(o);e.countyChoroplethScale=d3.scale.linear().domain([a,s]).range(["#FFFFBB","#BB00CC"]),e.minimapState.isLoading=!1,y(e.currentState),x(n,r,i)}),e.$on("$destroy",function(){f(),g(),h(),unwatchTableOfContents()})}}}]),function(){"use strict";angular.module("troutSpotr").controller("MainController",["$scope","StreamApiService","TableOfContentsRepository","RegionGeometryService","$anchorScroll",function(t,e,n,r,i){t.isSmallView=!0;var a=function(){var t={isExpanded:!1,isLoading:!1,selectedRegionGeometry:null,selectedRegion:null,selectedCounty:null,highlightedStream:null,currentClientCoordinates:[NaN,NaN]};return t};t.mapState=a(),t.selectCounty=function(t){console.log(t)},t.selectRegion=function(e){if(null==e)throw new Error("regionModel cannot be null");var n=!1;if(n)return t.mapState.selectedRegionGeometry=null,void(t.mapState.selectedRegion=[e]);var a=e.parent;return r.getRegion(a,e).then(function(n){return t.mapState.selectedRegionGeometry=[n],t.mapState.selectedRegion=[e],i("region-hdr_"+e.id),n})},t.getTableOfContents=function(){return n.getTableOfContents().then(function(t){return t})},t.bustCache=function(){console.log("busting cache..."),n.bustTableOfContentsCache()},t.toggleMinimap=function(){null!=t.mapState&&(t.mapState.isExpanded=!t.mapState.isExpanded)}}])}(),angular.module("troutSpotr").directive("accessPointSummaryTally",[function(){"use strict";return{templateUrl:"app/ui/accessPointSummary/AccessPointSummaryTallyTemplate.html",restrict:"A",link:function(t,e){var n=".js-tally-root",r=24,i=t.stream.AccessPoints.filter(function(t){return t.IsOverOrNearTroutStreamSection});t.denominator=i.length;var a=i.filter(function(t){return t.IsOverOrNearPublicLand});if(t.numerator=a.length,t.rows=Math.ceil(Math.sqrt(t.denominator)),0!==t.rows){var o=r/t.rows;t.box=d3.select(e[0]).select(n),t.box.selectAll("rect").data(i).enter().append("rect").attr("x",function(e,n){var r=n%t.rows*o+.9*o;return r}).attr("y",function(e,n){var r=Math.floor(n/t.rows)*o+.9*o;return r}).attr("width",o).attr("height",o).attr("class",function(t){return t.IsOverOrNearPublicLand?"numerator":"denominator"})}}}}]),angular.module("troutSpotr").directive("accessPointSummary",[function(){"use strict";return{templateUrl:"app/ui/accessPointSummary/AccessPointSummaryTemplate.html",restrict:"A",link:function(t){var e=t.stream.AccessPoints.filter(function(t){return t.IsOverOrNearTroutStreamSection});t.denominator=e.length;var n=e.filter(function(t){return t.IsOverOrNearPublicLand});t.numerator=n.length}}}]),angular.module("troutSpotr").factory("TableOfContentsRepository",["BaseApiService","RegionGeometryService","HierarchicalGeometryViewModel",function(t,e,n){"use strict";var r="tableOfContents",i=function(){t.call(this),this.logCache()},a=i.prototype=Object.create(t.prototype);return a.bustTableOfContentsCache=function(){this.cache.remove(r)},a.getTableOfContents=function(){var t=r;if(this.cache.get(t))return console.log("found in cache"),this.cache.get(t);var e=this.doCall({},"assets/data/tableOfContents.topo.json").then(function(t){var e=topojson.feature(t,t.objects.state),r=topojson.feature(t,t.objects.region),i=topojson.feature(t,t.objects.county),a=topojson.feature(t,t.objects.streamProperties),o=_(e.features).map(function(t){var e=new n,r=t.properties;return e.id=r.gid,e.name=r.name,e.centroidLatitude=NaN,e.shortName=r.short_name,e.centroidLongitude=NaN,e.parent=null,e.type="state",e.children=[],e.geometry=t,e}).indexBy("id").value(),s=_(r.features).map(function(t){var e=new n;return e.shortName=t.properties.name,e.id=t.properties.gid,e.name=t.properties.name,e.geometry=t,e.type="region",e}).sortBy("name").indexBy("id").value(),c=_(i.features).filter(function(t){return t.properties.stream_count>0}).map(function(t){var e=new n,r=t.properties;return e.id=r.gid,e.name=r.name,e.geometry=t,_.extend(e,r),e.type="county",e}).sortBy("name").indexBy("id").value(),l=_(c).groupBy("region_id").value(),u=o[49],d=_(s).groupBy(function(){return u.id}).value(),m=_(a.features).map(function(t){var e=new n,r=t.properties;return e.id=r.Id,e.name=r.Name,e.geometry=t,e.centroidLongitude=r.CentroidLongitude,e.centroidLatitude=r.CentroidLatitude,_.extend(e,r),e.type="streamCentroid",e}).sortBy("name").indexBy("id").value();return _.forEach(o,function(t){var e=t.id,n=d[e];t.children=n,_.forEach(t.children,function(e){var n=e.id,r=l[n];e.children=r,e.parent=t,_.forEach(e.children,function(t){t.parent=e})})}),_.forEach(m,function(t){_.forEach(t.Counties,function(e){var n=c[e.Id];n.children.push(t)})}),this.logCache(),o}.bind(this));return this.cache.put(t,e),e},i.prototype=a,new i}]),angular.module("troutSpotr").factory("HierarchicalGeometryViewModel",function(){function t(){this.init()}return t.prototype={id:null,name:"",shortName:"",geometry:null,centroidLatitude:NaN,centroidLongitude:NaN,type:null,parent:null,children:[],init:function(){this.id=null,this.name="",this.shortName="",this.geometry=null,this.centroidLongitude=NaN,this.centroidLatitude=NaN,this.parent=null,this.children=[]}},t}),angular.module("troutSpotr").factory("HierarchicalGeometryCollection",["BaseCollection","HierarchicalGeometryViewModel",function(t,e){function n(e){t.call(this,e)}var r=n.prototype=Object.create(t.prototype);return n.prototype.constructor=n,r.model=e,n}]),angular.module("troutSpotr").factory("RegionRepositoryService",["RegionGeometryService","TableOfContentsRepository","$q",function(t,e,n){var r=function(){},i={getRegions:function(){return e.getTableOfContents().then(function(t){console.log("got em")})},isCached:function(t){return!1},cacheRegion:function(t){return!0},uncacheRegion:function(t){return!0},getRegion:function(t){this.isCached()}};return r.prototype=i,new r}]);var REGION_CACHE_KEY="region",createKey=function(t,e){return REGION_CACHE_KEY+"_"+t+"_"+e};angular.module("troutSpotr").factory("RegionGeometryService",["BaseApiService","RegionApiService","HierarchicalGeometryViewModel",function(t,e,n){var r=function(){t.call(this)},i=r.prototype=Object.create(t.prototype);return i.getRegion=function(t,n){if(null==t||null==t.shortName)throw new Error("state cannot be null");if(null==n||null==n.shortName)throw new Error("region cannot be null");var r=t.shortName,i=n.shortName,a=createKey(r,i);if(this.cache.get(a))return console.log("found in cache"),this.cache.get(a);var o=e.getRegion(r,i).then(function(t){return console.log("new geom",t),t});return this.cache.put(a,o),o},r.prototype=i,new r}]);var createPath=function(t,e){return t+"/"+e+".topo.json"};angular.module("troutSpotr").factory("RegionApiService",["BaseApiService",function(t){var e=function(){t.call(this),this.logCache()},n=e.prototype=Object.create(t.prototype);return n.getRegion=function(t,e){if(null==t)throw new Error("stateId cannot be null");if(null==e)throw new Error("regionId cannot be null");var n=createPath(t,e);return this.doCall({},"assets/data/"+n)},e.prototype=n,new e}]),angular.module("troutSpotr").factory("StreamRatioViewModel",function(){var t=function(t,e){this.totalLength=0,this.publicLandLength=0,this.init(t,e)},e=t.prototype;return e.init=function(t,e){if(null==t||0>e)throw new Error("totalLength cannot be null or less than 0");if(null==e||0>e)throw new Error("publicLength cannot be null or less than 0");e>t&&(e=t),this.totalLength=t,this.publicLandLength=e;var n=function(t){var e=Math.sqrt(t/Math.PI);return e};this.waterRadius=n(this.totalLength);var r=this.publicLandLength/this.totalLength;this.publicLandRadius=this.waterRadius*r},t}),angular.module("troutSpotr").factory("StreamApiService",["$rootScope","$cacheFactory","$http","$q","$timeout",function(t,e,n,r,i){function a(){}return a.prototype={getStreams:function(){var t=r.defer();return i(function(){var e=n.get("./data/trout-dash-minnesota.json").then(function(t){return t.data});t.resolve(e)},1e3),t.promise},getRegions:function(){var t=r.defer();return i(function(){var e=n.get("./data/regionDetails.json").then(function(t){return t.data});t.resolve(e)},1e3),t.promise}},new a}]),angular.module("troutSpotr").factory("LinearReferenceViewModel",function(){var t=function(t,e){this.lineSegment=null,this.xOffset=0,this.width=0,this.init(t,e)};return t.prototype.init=function(t,e){this.lineSegment=t;var n=t.Stop*e,r=t.Start*e;this.xOffset=1-n,this.width=Math.abs(n-r)},t}),angular.module("troutSpotr").factory("GeometryApiService",["$rootScope","$cacheFactory","$http","$q","$timeout",function(t,e,n,r,i){function a(){}return a.prototype={getRegionGeometries:function(){var t=r.defer();return i(function(){var e=n.get("./data/regionGeometry.json").then(function(t){return t.data});t.resolve(e)},1e3),t.promise}},new a}]),angular.module("troutSpotr").factory("BaseModel",function(){function t(t){t&&this._fromJSON(t)}return t.prototype={constructor:t,_fromJSON:function(t){var e;for(e in t)t.hasOwnProperty(e)&&(this[e]=t[e])},toJSON:function(){var t,e={};for(t in this)this.hasOwnProperty(t)&&"function"!=typeof this[t]&&(e[t]=this[t]);return e},destroy:function(){var t;for(t in this)this.hasOwnProperty(t)&&delete this[t]}},t.generateIdomaticName=function(t){return t.type},t}),angular.module("troutSpotr").factory("BaseCollection",["BaseModel",function(t){function e(t){this._models=[],t&&this._addAll(t)}e.prototype={model:t,constructor:e,_models:null,length:0,toJSON:function(){return this.map(function(t){return t.toJSON()})},toArray:function(){return this._models.slice()},destroy:function(){this.each(function(t){t.destroy()}),this._models.length=0,this._models=null},copy:function(t){return t?new this.constructor(t):new this.constructor(this._models)},_addAll:function(t){var e,n=t.length;for(e=0;n>e;e++)this.add(t[e])},add:function(t){var e;return e=t instanceof this.model?t:new this.model(t),this._models.push(e),this.length++,this.length},remove:function(t){var e,n=t;return e=n instanceof this.model?this._removeByModel(n):this._removeById(n),e&&-1!==e&&this.length--,this.length},empty:function(){this._models.length=0,this.length=0},first:function(){return this._models[0]},sort:function(t){this._models.sort(t)},sortBy:function(t,e){this.sort(function(n,r){var i=n[t],a=r[t];return e?i>a?-1:a>i?1:0:a>i?-1:i>a?1:0})},sortByType:function(t,e,n){"string"===n?this.sortByString(t,e,!0):"arrayLength"===n?this.sortByCount(t,e):"number"===n?this.sortByNumber(t,e):this.sortBy(t,e)},sortByString:function(t,e,n){this.sort(function(r,i){var a=r[t],o=i[t];return n&&(a=a.toLowerCase(),o=o.toLowerCase()),e?a>o?-1:o>a?1:0:o>a?-1:a>o?1:0})},sortByCount:function(t,e){this.sort(function(n,r){var i=n[t]?n[t].length:0,a=r[t]?r[t].length:0;return e?i>a?-1:a>i?1:0:a>i?-1:i>a?1:0})},sortByNumber:function(t,e){this.sort(function(n,r){var i=n[t]?n[t]:0,a=r[t]?r[t]:0;return e?i>a?-1:a>i?1:0:a>i?-1:i>a?1:0})},get:function(t){for(var e=0,n=this._models.length;n>e;e++)if(this._models[e].id==t)return this._models[e]},at:function(t){return this._models[t]},getPage:function(t,e){var n=e*(t-1),r=n+e;return n>this._models.length-1?[]:this._models.slice(n,r)},contains:function(t){var e,n=this.length;for(e=0;n>e;e++)if(this._models[e].id===t)return!0;return!1},merge:function(t){var e,n,r;return this.constructor!==t.constructor?[]:(e=this,n=[],r=[],this.each(function(e,r){t.contains(e.id)||(this.remove(e.id),n.push(e.id))}),t.each(function(t,e){this.contains(t.id)||(this.add(t),r.push(t.id))}),{removed:n,added:r})},_removeById:function(t){var e,n=this.length;for(e=0;n>e;e++)if(this._models[e].id===t)return this._models.splice(e,1)},_removeByModel:function(t){var e,n=this.length;for(e=0;n>e;e++)if(this._models[e]===t)return this._models.splice(e,1)}};var n=["forEach","each","map","reduce","find","filter","indexOf"];return _.each(n,function(t){e.prototype[t]=function(){var e=Array.prototype.slice.call(arguments);return e.unshift(this._models),_[t].apply(_,e)}}),e.SORT={TYPE:{ARRAY_LENGTH:"arrayLength",STRING:"string",DATE:"date",NUMBER:"number"}},e}]),angular.module("troutSpotr").factory("BaseApiService",["$rootScope","$cacheFactory","$http","$q","$timeout",function(t,e,n,r,i){
function a(){this.cache=s}var o=(window.sessionStorage,800),s=e("du");return a.prototype={cache:null,resetCache:function(){s.removeAll()},logCache:function(){var t=this.cache.info();console.log("cache",t)},doCall:function(t,e,s){s=!1;var c={url:a.API_BASE_PATH+e,params:t,cache:s,method:"GET"},l=r.defer();return i(function(){var t=n(c).then(function(t){return t&&t.data&&t.data.exceptionType?r.reject(t.data):t.data})["catch"](function(t){return r.reject(t)});l.resolve(t)},o),l.promise}},a.API_BASE_PATH="",a}]),function(){"use strict";function t(t){t.debug("runBlock end")}angular.module("troutSpotr").run(t),t.$inject=["$log"]}(),function(){"use strict";function t(t,e){t.state("home",{url:"/",templateUrl:"app/ui/main/main.html",controller:"MainController",controllerAs:"main"}),e.otherwise("/")}angular.module("troutSpotr").config(t),t.$inject=["$stateProvider","$urlRouterProvider"]}(),function(){"use strict";angular.module("troutSpotr")}(),function(){"use strict";function t(t){t.debugEnabled(!0)}angular.module("troutSpotr").config(t),t.$inject=["$logProvider"]}(),angular.module("troutSpotr").run(["$templateCache",function(t){t.put("app/ui/accessPointSummary/AccessPointSummaryTallyTemplate.html",'<svg class="js-tally-root access-point" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%" viewbox="0 0 24 24"></svg>'),t.put("app/ui/accessPointSummary/AccessPointSummaryTemplate.html",'<span class="access-point"><span data-ng-class="{\'hide\': numerator === 0}" class="numerator">{{::numerator}}:</span><span class="denominator">{{::denominator}}</span></span>'),t.put("app/ui/main/main.html",'<div class="container"><div data-mini-map-directive=""></div><div data-stream-list=""></div></div>'),t.put("app/ui/miniMap/minimaptemplate.html",'<div class="somethingContainer" data-ng-class="{\'somethingContainer-major\': minimapState.isMacro}"><div class="js-mini-map something"></div></div>'),t.put("app/ui/restrictions/restrictionlegendtemplate.html",'<ul class="restrictions" data-ng-repeat="restriction in stream.Restrictions"><li><div class="media"><div class="media-hd legend" data-ng-class="{\'stream-line_restriction\': $index === 0, \'stream-line_restriction_secondary\': $index === 1}"></div><span class="media-bd heading">{{restriction.FullText}}</span></div></li></ul>'),t.put("app/ui/restrictions/streamrestrictiontemplate.html",'<ul class="restrictions" data-ng-repeat="restriction in restrictionViewModel.restrictions"><li><div class="media"><div class="media-hd legend {{restriction.cssClass}}"></div><span class="media-bd heading">{{restriction.text}}</span></div></li></ul>'),t.put("app/ui/speciesSummary/speciessummarytemplate.html",'<span class="icon"><svg preserveaspectratio="xMidYMid meet" width="100%" height="100%" viewbox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" class="species"><g><g class="species brown"><circle class="population" data-is-populated="{{::stream.HasBrownTrout}}" data-ng-class="{\'none\': stream.HasBrownTrout === false}" cx="4" cy="12" r="2.5"></circle><circle class="stocking {{stream.HasStockedBrownTrout ? \'stocked\' : \'none\'}}" data-is-stocked="{{::stream.HasStockedBrownTrout}}" cx="4" cy="12" r="2.7"></circle></g><g class="species brook"><circle class="population" data-is-populated="{{::stream.HasBrookTrout}}" data-ng-class="{\'none\': stream.HasBrookTrout === false}" cx="12" cy="12" r="2.5"></circle><circle class="stocking {{stream.HasStockedBrookTrout ? \'stocked\' : \'none\'}}" data-is-stocked="{{::stream.HasStockedBrookTrout}}" cx="12" cy="12" r="2.7"></circle></g><g class="species rainbow"><circle class="population" data-is-populated="{{::stream.HasRainbowTrout}}" data-ng-class="{\'none\': stream.HasRainbowTrout === false}" cx="8" cy="5.0718" r="2.5"></circle><circle class="stocking {{stream.HasStockedRainbowTrout ? \'stocked\' : \'none\'}}" data-is-stocked="{{::stream.HasStockedRainbowTrout}}" cx="8" cy="5.0718" r="2.7"></circle></g></g></svg></span>'),t.put("app/ui/streamLine/streamlinetemplate.html",'<div class="js-stream-line"></div>'),t.put("app/ui/streamList/streamlisttemplate.html",'<div data-ng-cloak="" id="js-list-container"><div data-ng-repeat="region in mapState.selectedRegion | limitTo:1 | orderBy:\'name\'" id="{{::getRegionId(region)}}" data-region-header=""></div></div>'),t.put("app/ui/streamRatio/streamratiotemplate.html",'<svg class="stream-ratio" preserveaspectratio="xMidYMid meet" width="100%" height="100%" viewbox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg"><g class="stream-line_route"><circle cx="8" cy="8" ng-attr-r="{{::streamRatio.waterRadius * 2.2}}"></circle></g><g class="stream-ratio_public-land"><circle cx="8" cy="8" ng-attr-r="{{::streamRatio.publicLandRadius * 2.2}}"></circle></g></svg>'),t.put("app/ui/streamList/county/CountyHeaderTemplate.html",'<div fsm-sticky-header="" scroll-body="getCountyScrollBodyId(county)" scroll-stop="23" scroll-object="county" z-index-override="10000" class="sectionTitle region-header">{{::county.name}} Co. {{displayedStreams.length}} : {{county.children.length}}</div><div infinite-scroll="loadMoreStreams()" infinite-scroll-distance="1"><div ng-class-odd="\'box\'" ng-class-even="\'box box-secondary\'" data-ng-repeat="stream in displayedStreams"><div data-stream-list-item-directive=""></div></div></div>'),t.put("app/ui/streamList/region/RegionHeaderTemplate.html",'<div fsm-sticky-header="" scroll-body="getRegionScrollBodyId(region)" scroll-stop="0" scroll-object="region" z-index-override="10100" class="sectionTitle region-header"><a id="region-hdr_{{region.id}}" href="#">{{::region.name}} {{displayedCounties.length}} : {{region.children.length}}</a></div><div infinite-scroll="loadMoreCounties()" infinite-scroll-distance="1"><div data-ng-repeat="county in displayedCounties" id="{{::getCountyId(county)}}" data-county-header=""></div></div>'),t.put("app/ui/streamList/streamListItem/StreamListItemHeaderTemplate.html",'<div class="header-container"><div data-ng-click="expand()" class="primary"><span data-stream-ratio="" class="icon"></span> <span class="title">{{::stream.Name}}</span></div><div class="details header-container"><div class="icon"><div data-species-summary=""></div></div><div class="icon" data-access-point-summary=""></div><div class="icon"><svg class="alert" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="40%" height="40%" viewbox="0 0 32 32"><path d="M31.858 27.675c-3.196-5.42-11.116-18.857-14.395-24.42-0.987-1.672-1.947-1.641-2.859-0.096-3.223 5.464-11.137 18.878-14.395 24.402-0.004 0.006-0.87 2.439 0.954 2.439h29.561c1.969 0 1.048-2.471 1.134-2.325z"></path><text class="alert-text" x="12" y="25" font-family="Futura" font-size="24">!</text></svg></div></div></div>'),t.put("app/ui/streamList/streamListItem/streamlistitemtemplate.html",'<div class="box" data-stream-id="{{::stream.Id}}"><div><div data-stream-list-item-header=""></div><div data-ng-if="isSmall === false"><div class="containerBody grid-row"><div class="grid-row-col_12of12"><div data-stream-line=""></div></div></div><div class="grid-row"><div class="grid-row-col grid-row-col_9of12 media_list"><div data-ng-if="stream.Restrictions.length > 0" data-restriction-legend=""></div><div data-ng-repeat="accessPoint in stream.AccessPoints | orderBy:\'LinearOffset\':true"><span class="roadIntersectionIndicator" data-ng-class="{\'roadIntersectionIndicator_public\': accessPoint.IsOverOrNearPublicLand}"></span> <span class="roadIntersectionIndicator troutStreamIntersection" data-ng-class="{\'troutStreamIntersection_none\': accessPoint.IsOverOrNearTroutStreamSection === false}"></span> <a class="heading" target="_blank" href="https://www.google.com/maps/@{{accessPoint.Latitude}},{{accessPoint.Longitude}},17z">{{accessPoint.Name}}</a></div></div><div class="grid-row-col grid-row-col_3of12"><div data-stream-ratio-text=""></div></div></div></div></div></div>')}]);
//# sourceMappingURL=../maps/scripts/app-c501d6b5e9.js.map
